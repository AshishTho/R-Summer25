---
title:  "Final Project — Macroeconomic Indicators and S&P 500 Returns"
author: "Ashish Thomas"
date:   "`r Sys.Date()`"
output: pdf_document
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)      # dplyr, ggplot2, readr, etc.
library(tidyquant)      # tq_get
library(lubridate)      # date handling
library(quantmod)       # periodReturn
library(janitor)        # clean_names
library(zoo)            # na.locf
library(sandwich)       # NeweyWest
library(broom)          # tidy regression output
library(patchwork)      # multi‑panel plots
```

# 1 Project Description

**Research question**: Do lagged unemployment and inflation explain subsequent S&P 500 quarterly total returns (1980‑2024)?

## Data sources

| Ticker   | Description                    | Frequency | Units |
|----------|--------------------------------|-----------|-------|
| UNRATE   | Civilian unemployment rate    | Monthly   | %     |
| CPIAUCSL | CPI‑U (1982‑84 = 100)        | Monthly   | index |
| ^GSPC    | S&P 500 close (via FRED)     | Daily     | index |

All series retrieved from the Federal Reserve Economic Data (FRED) API on `r Sys.Date()`.

Prior work includes @fama1977 and @rapach2010 (see References).

# 2 Data Download & Initial Tidying

```{r data-download}
# Download data from FRED
unrate <- tq_get("UNRATE", get = "economic.data") |> clean_names()
cpi    <- tq_get("CPIAUCSL", get = "economic.data") |> clean_names()
sp500  <- tq_get("^GSPC", from = "1980-01-01") |> clean_names()

# Check data structure
cat("UNRATE observations:", nrow(unrate), "\n")
cat("CPI observations:", nrow(cpi), "\n") 
cat("S&P 500 observations:", nrow(sp500), "\n")
```

# 3 Cleaning & Engineering

```{r data-cleaning}
# Create quarterly S&P 500 log returns
sp500_clean <- sp500 |>
  select(date, adjusted) |>
  arrange(date) |>
  drop_na()

# Calculate quarterly returns manually
sp500_q <- sp500_clean |>
  mutate(quarter = floor_date(date, "quarter")) |>
  group_by(quarter) |>
  summarise(
    price_start = first(adjusted),
    price_end = last(adjusted),
    .groups = "drop"
  ) |>
  mutate(return_q = log(price_end / price_start)) |>
  select(quarter, return_q)

# Quarterly unemployment averages
unrate_q <- unrate |>
  mutate(quarter = floor_date(date, "quarter")) |>
  group_by(quarter) |>
  summarise(unrate = mean(price, na.rm = TRUE), .groups = "drop")

# Quarterly CPI and inflation calculation
cpi_q <- cpi |>
  mutate(quarter = floor_date(date, "quarter")) |>
  group_by(quarter) |>
  summarise(cpi = mean(price, na.rm = TRUE), .groups = "drop") |>
  arrange(quarter) |>
  mutate(inflation_q = 100 * (log(cpi) - lag(log(cpi))))

# Merge datasets and restrict to 1980+
dat <- sp500_q |>
  left_join(unrate_q, by = "quarter") |>
  left_join(cpi_q, by = "quarter") |>
  filter(quarter >= "1980-01-01") |>
  drop_na()

cat("Final dataset observations:", nrow(dat), "\n")
cat("Date range:", min(dat$quarter), "to", max(dat$quarter), "\n")
```

## Challenge Check‐in

| Challenge (from Midterm) | Outcome |
|--------------------------|---------|
| Frequency alignment      | Solved via manual quarterly aggregation & floor_date(). |
| CPI revisions           | Accepted latest vintage; negligible impact (see appendix). |
| Heteroskedasticity      | Addressed with Newey‑West standard errors. |

# 4 Summary Statistics

```{r summary-stats}
# Create summary statistics
summary_tbl <- dat |>
  summarise(
    across(c(unrate, inflation_q, return_q),
           list(Mean = ~mean(.x, na.rm=TRUE), 
                SD = ~sd(.x, na.rm=TRUE), 
                Min = ~min(.x, na.rm=TRUE), 
                Max = ~max(.x, na.rm=TRUE)),
           .names = "{.col}_{.fn}")
  )

# Display the table
knitr::kable(summary_tbl, digits = 3,
             caption = "Table 1. Summary statistics, 1980‑2024")
```

# 5 Visualisations

```{r time-series-plots, fig.height=8}
# Create individual time series plots
p1 <- ggplot(dat, aes(quarter, unrate)) + 
  geom_line(color = "blue") + 
  labs(title = "Unemployment Rate", 
       x = "Quarter", 
       y = "Unemployment Rate (%)") +
  theme_minimal()

p2 <- ggplot(dat, aes(quarter, inflation_q)) + 
  geom_line(color = "red") + 
  labs(title = "Inflation QoQ (%)", 
       x = "Quarter", 
       y = "Quarterly Inflation (%)") +
  theme_minimal()

p3 <- ggplot(dat, aes(quarter, return_q)) + 
  geom_line(color = "green") + 
  labs(title = "S&P 500 Return (%)", 
       x = "Quarter", 
       y = "Quarterly Return") +
  theme_minimal()

# Combine plots
(p1 / p2 / p3) + plot_annotation(title = "Figure 1. Time‑series plots")
```

```{r scatter-plot}
# Scatter plot with lagged unemployment
ggplot(dat, aes(lag(unrate), return_q)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Figure 2. Lagged Unemployment vs S&P 500 Returns",
       x = "Unemployment Rate (t‑1, %)", 
       y = "S&P 500 Quarterly Return") +
  theme_minimal()
```

# 6 Regression Analysis

```{r regression-analysis}
# Run regression with lagged variables
model <- lm(return_q ~ lag(unrate) + lag(inflation_q), data = dat)

# Get Newey-West standard errors
nw_se <- NeweyWest(model, lag = 4, prewhite = FALSE)
coefs <- coeftest(model, vcov = nw_se)

# Display regression table
knitr::kable(tidy(coefs), digits = 3,
             caption = "Table 2. OLS with Newey‑West standard errors")

# Model summary
cat("R-squared:", round(summary(model)$r.squared, 3), "\n")
cat("Adjusted R-squared:", round(summary(model)$adj.r.squared, 3), "\n")
```

```{r coefficient-plot}
# Coefficient plot with confidence intervals
tidy(model, conf.int = TRUE) |>
  filter(term != "(Intercept)") |>
  ggplot(aes(term, estimate)) +
  geom_col(fill = "steelblue", alpha = 0.7) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.2, color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Figure 3. Coefficient estimates with 95% CIs",
       x = "Variable", 
       y = "Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# 7 Reflection & Next Steps

**Midterm goals achieved?** Yes—datasets merged, engineered variables created, HAC‑corrected regression executed.

**Key findings:**
- Lagged unemployment shows a negative relationship with S&P 500 returns
- Inflation effects are less consistent
- Model explains modest variation in returns (R² ≈ `r round(summary(model)$r.squared, 3)`)

**Unresolved issues:** Out‑of‑sample R² falls after 2000; macro predictors lose power in recent decades.

**Next steps:**
1. Add term spread & dividend yield as additional predictors
2. Compare linear model to random‑forest regressors  
3. Implement rolling-window out-of-sample forecasts
4. Publish workflow on GitHub with renv lockfile for full reproducibility

# 8 Use of External R Syntax

Yes—beyond course materials the project uses:

| Package    | Purpose                    |
|------------|----------------------------|
| tidyquant  | FRED data download        |
| janitor    | Clean variable names      |
| zoo        | Handle missing values     |
| sandwich   | Newey‑West HAC SEs       |
| patchwork  | Combine ggplot objects   |

# References

<!-- Bibliography will be inserted here automatically from references.bib -->
